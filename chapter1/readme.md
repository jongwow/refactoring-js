# 리팩터링: 첫 번째 예시

## 1.2 예시 프로그램을 본 소감

> 프로그램이 새로운 기능을 추가하기에 편한 구조가 아니라면, 먼저 기능을 추가하기 쉬운 형태로 리팩터링하고 나서 원하는 기능을 추가한다.

이 코드에서 수정해야하는 몇가지 부분

- 청구 내역을 HTML으로 출력하는 기능.
  - 이 변경으로, statement()함수의 복잡도 크게 증가. -> 그렇다고 statement()함수와 똑같이 수행하되 html을 출력하는 statement_html()을 만든다면?
  - 청구서 작성 로직이 변경될때마다 모두 수정해야하고 일관성을 확인해야함. 매우 힘듦.
- 배우들은 언제 어떤 연극을 할지 모른다.
  - 연극, 시간 등에 따른 변경이 공연료, 적립 포인트 계산법 등에 영향.
  - 그럴때마다 statement()를 수정해야한다면? -> statement_html()도 수정해야함.

## 1.3 리팩터링의 첫 단계

> 리팩터링하기 전에 제대로 된 테스트부터 마려한다. 테스트는 반드시 자가진단하도록 만든다.

## 1.4 statement() 쪼개기

- statement()처럼 긴 함수를 리팩터링할 때는 먼저 전체 동작을 각각의 부분으로 나눌 수 있는 지점을 찾는다. 그러면 중간 즈음의 switch()문이 가장 먼저 눈에 띌 것이다.

- swtich문은 한 번의 공연에 대한 요금ㅇ르 게산. 이런 사실은 휘발 -> 뇌에 저장하기보단 코드에 저장 -> 다음에 봤을 때 다시 분석하지 않아도 코드 스스로가 자신이 하는 일이 무엇인지 이야기해준다.
- 코드 조각을 별도 함수로 추출하는 방식; 함수 추출하기
  - 별도 함수로 빼냈을 때 유효범위를 벗어나는 변수, 즉 새 함수에서는 곧바로 사용할 수 없는 변수 확인

> 리팩터링은 프로그램 수정을 작은 단계로 나눠 진행한다. 그래서 중간에 실수하더라도 버그를 쉽게 찾을 수 있다.

- 다음 단계는 변경 사항을 VCS 에 커밋한다. 하나의 리팩터링을 문제없이 끝낼 때마다 커밋해야 중간에 문제가 생기더라도 이전의 정상 상태로 쉽게 돌아갈 수 있다.

> 컴퓨터가 이해하는 코드는 바보도 작성할 수 있다. 사람이 이해하도록 작성하는 프로그래머가 진정한 실력자다.

- play변수는 aPerformance 에서 얻을 수 있기 때문에 매개 변수로 필요하지 않다. 긴 함수를 잘게 쪼갤 때마다 play와 같은 임시 변수는 최대한 제거한다. 이를 해결하는 리팩털링은 **임시 변수를 질의 함수로 바꾸기** 가 있다.

- 임시 변수는 나중에 문제를 일으킬 수 있다. 자신이 속한 루틴에서만 의미가 있기 때문에 루틴이 길고 복잡해지기 수비다. 이런 변수를 제거하자. 그 중 format을 제거할 것이다.

- volumeCredits 변수 제거. 반복문을 한 바퀴 돌 때마다 값을 누적하기 때문에 리팩터링 까다롭. 먼저 **반복문 쪼개기**로 volmeCredits 값이 누적되는 부분을 따로 빼낸다.

- 이렇게 리팩터링하면? 반복문이 쪼개져서 성능이 느려지지 않을까? 이정도 중복은 미미. 똑똑한 컴파일러들은 최신 캐싱 기법 등으로 무장하고 있어서 우리의 직관을 초월하는 결과를 내어주기 때문. SW 성능은 코드의 몇몇 작은 부분에 의해 결정되므로 이정도는 성능 차이 체감 힘듦.
- 물론 항상 그런건 아님. 성능에 영향을 주기도 함. 근데도 리팩터링! 왜냐하면 리팩터링이 되어야 성능개선이 더 쉬워짐.

- volumeCredit 변수를 제거하는 작업의 단위는 아래처럼 진행. 매 작업마다 컴파일-테스트-커밋

1. 반복문 쪼개기: 변수 값을 누적시키는 부분을 분리.
2. 문장을 슬라이드하기: 변수 초기화 문장을 변수 값 누적 코드 바로 앞으로 이동.
3. 함수 추출하기: 적립 포인트 계산 부분을 별도 함수로 추출.
4. 변수 인라인하기: 변수를 제거한다.

## 1.6 계산 단계와 포맷팅 단계 분리하기
- 지금까진 프로그램의 논리적인 요소를 위해 코드 구조 보강. 이제 statement()의 HTML 버전 만드는 것. 계산 코드가 모두 분리되었기 때문에 최상단에 대응하는 HTML 버전만 만들면 된다. 근데 분리된 계산 함수들이 모두 statement() 안에 중첩 함수로 선언되어있음. 그걸 Copy & Paste 로 statement_html()에 넣는건 무리데스.
- 이럴 때 마틴 파울러옹은 **단계 쪼개기** 를 선호. statement()의 로직을 두단ㄷ계로 나누는 것. 첫 단계는 statement()에 필요한 데이터를 처리하고 다음 단계에서 표현하는 것. 그 사이에 데이터를 전달할 객체를 만드는 것.


## 1.7 중간 점검: 두 파일(과 두 단계)로 분리됨
